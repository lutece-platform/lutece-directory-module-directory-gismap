
<#assign editModeValue = "">
<#if entry.fields?? && entry.fields?has_content>
	<#list entry.fields as field>
		<#if field?? && field.title = "editMode">
			<#if field.value == "Address" || field.value == "Adresse" >
				<#assign editModeValue = "SuggestPOI" >
			</#if>
			<#if field.value == "Point" >
				<#assign editModeValue = "Point" >
			</#if>
			<#if field.value == "Line" || field.value == "Ligne">
				<#assign editModeValue = "LineString" >
			</#if>
			<#if field.value == "Polygon" || field.value == "Polygone">
				<#assign editModeValue = "Polygon" >
			</#if>
			<#break>
		</#if>
	</#list>
</#if>
<#assign fieldParam = {"TypeEdit" : "${editModeValue}", "GeomGeoJson" : "${entry.idEntry}_geometry", "GeomCentroidXStockage" : "${entry.idEntry}_x", "GeomCentroidYStockage" : "${entry.idEntry}_y", "GeomCentroidXGeocodage" : "${entry.idEntry}_geomCentroidXGeocodage", "GeomCentroidYGeocodage" : "${entry.idEntry}_geomCentroidYGeocodage", "GeomState" : "${entry.idEntry}_geomState", "ExtentCurrent" : "${entry.idEntry}_extent_current", "VisibleLayer" : "${entry.idEntry}_visible_layer", "UrlGeoJSON1" : "", "Proxy" : "rest/gismapp/gisproxy?url="} >
<input type="hidden" id="${entry.idEntry}_map_provider" name="${entry.idEntry}_map_provider" value="${entry.mapProvider.key}"/>

<#include entry.mapProvider.getParameter(viewNumberAttValue?number).mapTemplateFile />

<script src="js/autocomplete/external/jquery/jquery.js"></script>
<script src="js/autocomplete/jquery-ui.js"></script>

<script type="text/javascript">
$("#${entry.idEntry}_address").autocomplete({
	source : function(request, reponse){ // les deux arguments représentent les données nécessaires au plugin
	$.ajax({
		url : "${add_parameter.url}",
	    dataType: "jsonp",
	    data: {
	    	clientId : "${add_parameter.clientId}",
			nbResults : ${add_parameter.nbResult}, 
			types : "${add_parameter.listType}",
			query : request.term
			
	    },
	    success : function(data){
            reponse($.map(getResult(data.result), function(objet){
            	return objet;
                
            }));
        }
    	});
	},
	select : function(event, ui){
		$('#${entry.idEntry}_x').val(ui.item.x);
		$('#${entry.idEntry}_y').val(ui.item.y);
		$('#${entry.idEntry}_additional_address').val(getAdditionalAdd(ui.item.label));
		GisMapDisplay${entry.idEntry}.getZoom().zoomSuggestPoi(ui.item.x, ui.item.y);
		
    }
}).focus();
function getResult(result) {
	var resultArray = [];
	var index;
	for	(index = 0; index < result.length; index++) {
		var object = new Object();
		object.value = result[index].libelleTypo;
		object.label = result[index].libelleTypo;
		object.x = result[index].x;
		object.y = result[index].y;
		object.id = result[index].id;
		resultArray.push(object);
	}
	return resultArray;	
};
function getAdditionalAdd (address)
{
	var addTab = address.split(",");
	var addCompTab = addTab[1].split(" ");
	var additionalAdd = addCompTab[1];
	var additionalAddress = "";
	switch ( additionalAdd ) {
	    case "75001": additionalAddress = "1er arrondissement"; break;
	    case "75002": additionalAddress = "2e arrondissement"; break;
	    case "75003": additionalAddress = "3e arrondissement"; break;
	    case "75004": additionalAddress = "4e arrondissement"; break;
	    case "75005": additionalAddress = "5e arrondissement"; break;
	    case "75006": additionalAddress = "6e arrondissement"; break;
	    case "75007": additionalAddress = "7e arrondissement"; break;
	    case "75008": additionalAddress = "8e arrondissement"; break;
	    case "75009": additionalAddress = "9e arrondissement"; break;
	    case "75010": additionalAddress = "10e arrondissement"; break;
	    case "75011": additionalAddress = "11e arrondissement"; break;
	    case "75012": additionalAddress = "12e arrondissement"; break;
	    case "75013": additionalAddress = "13e arrondissement"; break;
	    case "75014": additionalAddress = "14e arrondissement"; break;
	    case "75015": additionalAddress = "15e arrondissement"; break;
	    case "75016": additionalAddress = "16e arrondissement"; break;
	    case "75116": additionalAddress = "16e arrondissement"; break;
	    case "75017": additionalAddress = "17e arrondissement"; break;
	    case "75018": additionalAddress = "18e arrondissement"; break;
	    case "75019": additionalAddress = "19e arrondissement"; break;
	    case "75020": additionalAddress = "20e arrondissement"; break;
	    default: if(addCompTab[2] == "" ) additionalAddress = addCompTab[1]; else additionalAddress = addCompTab[2];
	}
	return additionalAddress;
};

function geocodage${entry.idEntry}(){
	var webappURL = $('#webapp_url').val();
	var valX = $('#${entry.idEntry}_geomCentroidXGeocodage').val();
	var valY = $('#${entry.idEntry}_geomCentroidYGeocodage').val();
	$.ajax({
		url: webappURL + "rest/gismap/xy/" + valX + "," + valY,
        dataType: "jsonp",
	    jsonpCallback: 'callback',
        success: function( data ) {
			var address = data.Adresse_tot+", "+data.Codepostal+" ";
        	$("#${entry.idEntry}_address").val(address);
			$("#${entry.idEntry}_additional_address").val(getAdditionalAdd(address));
    	}
    });
};
</script>

<noscript>#i18n{module.genericattributes.gis.javascript.disabled}</noscript>